class BackupTransaction(Base):
    __tablename__ = "backup_transactions"

    id = Column(Integer, primary_key=True, autoincrement=True)
    Transaction_ID = Column(
        String(50), index=True
    )  # Not unique - allows duplicates from CSV cycles
    User_ID = Column(String(50))
    Transaction_Amount = Column(Numeric(12, 2))
    Transaction_Type = Column(String(50))
    Timestamp = Column(DateTime)
    ingested_at = Column(DateTime, default=lambda: datetime.now(timezone.utc))

    Account_Balance = Column(Numeric(15, 2))
    Device_Type = Column(String(50))
    Location = Column(String(100))
    Merchant_Category = Column(String(100))
    IP_Address_Flag = Column(Integer)
    Previous_Fraudulent_Activity = Column(Integer)
    Daily_Transaction_Count = Column(Integer)
    Avg_Transaction_Amount_7d = Column(Numeric(12, 2))
    Failed_Transaction_Count_7d = Column(Integer)
    Card_Type = Column(String(50))
    Card_Age = Column(Integer)
    Transaction_Distance = Column(Numeric(12, 2))
    Authentication_Method = Column(String(50))
    Is_Weekend = Column(Integer)
    Fraud_Label = Column(Integer)


class Transaction(Base):
    __tablename__ = "transactions"

    Transaction_ID = Column(String(50), primary_key=True)
    User_ID = Column(String(50))
    Transaction_Amount = Column(Numeric(12, 2))
    Transaction_Type = Column(String(50))
    Timestamp = Column(DateTime)
    ingested_at = Column(DateTime, default=lambda: datetime.now(timezone.utc))

    Account_Balance = Column(Numeric(15, 2))
    Device_Type = Column(String(50))
    Location = Column(String(100))
    Merchant_Category = Column(String(100))
    IP_Address_Flag = Column(Integer)
    Previous_Fraudulent_Activity = Column(Integer)
    Daily_Transaction_Count = Column(Integer)
    Avg_Transaction_Amount_7d = Column(Numeric(12, 2))
    Failed_Transaction_Count_7d = Column(Integer)
    Card_Type = Column(String(50))
    Card_Age = Column(Integer)
    Transaction_Distance = Column(Numeric(12, 2))
    Authentication_Method = Column(String(50))
    Is_Weekend = Column(Integer)
    Fraud_Label = Column(Integer)


class Verdict(Base):
    __tablename__ = "verdicts"

    id = Column(Integer, primary_key=True, autoincrement=True)
    Transaction_ID = Column(String(50), ForeignKey("transactions.Transaction_ID"))

    ensemble_score = Column(Float, default=0.0)
    model_scores = Column(JSON)
    rule_fraud_score = Column(Float, default=0.0)

    flag = Column(Integer)
    rule_flagged = Column(Integer, default=0)
    ai_flagged = Column(Integer, default=0)

    status = Column(String(20))
    reason_trail = Column(Text)
    created_at = Column(DateTime, default=lambda: datetime.now(timezone.utc))


class LLMReview(Base):
    __tablename__ = "llm_reviews"

    Transaction_ID = Column(
        String(50),
        ForeignKey("transactions.Transaction_ID"),
        primary_key=True,
        unique=True,
    )
    User_ID = Column(String(50))
    ensemble_score = Column(Float)
    llm_analysis = Column(Text)
    reviewed_at = Column(DateTime, default=lambda: datetime.now(timezone.utc))
    updated_at = Column(
        DateTime,
        default=lambda: datetime.now(timezone.utc),
        onupdate=lambda: datetime.now(timezone.utc),
    )